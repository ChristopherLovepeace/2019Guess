<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="css/style.css">
    <title>Guess my number</title>
<<<<<<< HEAD
    <link rel="stylesheet" type="text/css" href="styles.css">
</head>
<body>
        <div class="container">
                <div id="title">
                    <h1>Guess my Number Game</h1>
                    <p>for MM220 2019</p>
                </div>
                <div id="cred">
                    <div id="userVisible"></div>
                    <template id="userTemp">
                        <div id="userHidden">
                           <label id="label1" for="userName"><bold>Your User-Name: </bold></label><input id="userName" type="text"><br>
                            <button id="button1">Enter</button> 
                        </div>
                    </template>
                    <div id="guessVisible"></div>
                    <template id="guessTemp">
                        <div id="guessHidden">
                            <label id="label2" for="guess"><bold>Your Guess: </bold></label><input id="guess" type="text"><br>
                            <button id="button2">Guess!</button>
                        </div>
                    </template>
                    
                </div>
                <div id="action">
                    <h2 id="responseAction"></h2>
                </div>
                <div id="code">
                    <p id="currentPlayer">Current Players: </p>
                    <p id="responseCode"></p>    
                </div>
        
            </div>

    <script>
        const lang = "en";
        let cred = document.getElementById("cred");
        let res = document.getElementById("responseAction");
        let resCode = document.getElementById("responseCode");
        let curPlayers = document.getElementById("currentPlayer");


        
        function showUserTemp(){
            let temp = document.getElementById('userTemp');
            let placement = document.getElementById('userVisible');
            let clonedTemp = temp.content.cloneNode(true); 
            placement.appendChild(clonedTemp);
            let button1 = document.getElementById("button1");
            let nameInput = document.getElementById("userName");
            button1.addEventListener("click", function(evt){
            userName = nameInput.value;

            if(nameCheck(userName)){
                showGuessTemp();
                get(userName);

            }   
            
        });

        }
        function showGuessTemp(){
            let temp = document.getElementById('guessTemp');
            let placement = document.getElementById('guessVisible');
            let clonedTemp = temp.content.cloneNode(true); 
            placement.appendChild(clonedTemp);
            let button2 = document.getElementById("button2");
            let guessInput = document.getElementById("guess")
            button2.addEventListener("click", function(evt){
                guess = guessInput.value;
                if(guess){
                    post(userName, guess);    
                }   
            
            });
        }

        function language(KEY){
            //Only speaks in English so far   
        }

        function nameCheck(userName){
            
            let regex = /[^\d][a-zA-Z]{1,15}[^\d]/;
            let regexTst = regex.test(userName);
            if(regexTst){
                res.innerText = "";
                return true;
            }else if(userName.length > 15){
                res.innerText = `Your name is too long, please try again.`;
            }else{
                res.innerText = `${userName} is not a proper name, please try again.`;
            }
            
        };
    
        async function get(userName){
           
            let head = {
                "Content-type":"application/json",
                "accept-language": lang
            };
            let cfg = {
                method: 'GET',
                headers: head
            };
            let url = `start/${userName}/`;
            try{
                let resp = await fetch(url, cfg);
                let data = await resp.json();
                resCode.innerText = `Guess my number between ${data.min} and ${data.max}`;

            }
            catch(err){
                console.log(err);
            } 
        }
        async function post(userName, guess){
            let head = {
                "Content-type":"application/json",
                "accept-language": lang
            };
            let cfg = {
                method: 'POST',
                headers: head
            };
            let url = `guess/${userName}/${guess}/`;
            try{
                let resp = await fetch(url, cfg);
                let data = await resp.json();
                resCode.innerText = data.msg;
                curPlayers.innerText = `Current Players: ${data.users}`;
            }
            catch(err){
                console.log(err);
            } 
        }
        
        
        showUserTemp();
        
    </script>
=======
    <link rel="stylesheet" type="text/css" href="./css/client.css">
</head>
<body>
<select id="languages">
    <option value="en" selected><img src="img/flag_en.png"/> EN</option>
    <option value="no">NO</option>
    <option value="ro">RO</option>
    <option value="fr">FR</option>
    <option value="ar">AR</option>
    <option value="de">DE</option>
    <option value="bg">BG</option>
    <option value="sa">SA</option>
</select>
<div id="welcome">Guess my number!</div>
<label for="user" class="label" id="usertxt">Username: </label><br/>
<input id="user" type="text" class="input"><br/>
<div id="start" class="button">Start new game</div>
<div id="minmax"> </div>
<label for="guess" class="label" id="guesstxt">Your guess: </label><br/>
<input id="guess" type="number" class="input">
<div id="sendGuess" class="button">Guess!</div>
<div id="outDiv"> </div>
<div id="users">
    <div id="players">Players:</div>
    <div id="usersNr">0</div>
</div>

</body>
  <script type="module" src="js/client.js"></script>
<script>
    const MSG_KEY = {
        NO_NAME: "NO_NAME",
        NO_GUESS: "NO_GUESS",
        USERNAME: "USERNAME",
        YOUR_GUESS: "YOUR_GUESS",
        PLAYERS: "PLAYERS",
        START: "START",
        GUESS: "GUESS",
        INSTRUCTIONS: "INSTRUCTIONS"
    };

    let usertxt = document.getElementById("usertxt");
    let guesstxt = document.getElementById("guesstxt");
    let playerstxt = document.getElementById("players");

    let userin = document.getElementById("user");
    let guessin = document.getElementById("guess");
    let userNr = document.getElementById("usersNr");

    let languageSelect = document.getElementById("languages");

    let guessbtn = document.getElementById("sendGuess");
    let startbtn = document.getElementById("start");

    let numDiv = document.getElementById("minmax");
    let outDiv = document.getElementById("outDiv");

    guessbtn.addEventListener('click', tryGuess);
    startbtn.addEventListener('click', tryStart);

    window.addEventListener('keyup', hitEnter);

    languageSelect.addEventListener('change', changeLang);

    let MIN;
    let MAX;
    let msgCache;

    changeLang();

    function tryGuess() {
        let id = checkUser(userin.value);
        let guess = checkGuess(guessin.value);
        let lang = languageSelect.value;

        if(id && guess) {
            fetch(`guess/${id}/${guess}`,
                {
                    method:'POST',
                    headers: {
                        'Content-type' : 'application/json',
                        'accept-language' : lang
                    }
                }
            ).then(resp => {
                if(resp.ok) {
                    resp.text().then(resp => {

                        let answer = JSON.parse(resp);

                        writeOut(answer.users, userNr, 'div', true);
                        writeOut(msgCache.INSTRUCTIONS, numDiv, 'h3', true);
                        writeOut(`${MIN} - ${MAX}`, numDiv,'h3', false);
                        if(answer.code === 2030) {
                            writeOut(`${answer.winner} has won!`, outDiv, 'h2', true);
                            writeOut(`The right number was ${answer.number}.`,outDiv, 'h2', false);

                        } else {
                            writeOut(`${guess}: ${answer.msg}`, outDiv, 'h2', true);
                        }

                    })
                }
                else {
                    console.log(resp);
                }
            });
        }
        else if (!id){
            sendError(MSG_KEY.NO_NAME);
        }
        else if (!guess) {
            sendError(MSG_KEY.NO_GUESS);
        }
    }

    function tryStart() {
        let lang = languageSelect.value;

        let id = checkUser(userin.value);
        if(id) {
            fetch(`/start/${id}`,
                {
                    headers: {
                        'Content-type' : 'application/json',
                        'accept-language' : lang
                    }
                }
            ).then(resp => {
                if(resp.ok) {
                    resp.text().then(resp => {
                        let answer = JSON.parse(resp);

                        MIN = answer.min;
                        MAX = answer.max;

                        clearDiv(outDiv);
                        writeOut(answer.users, userNr, 'div', true);
                        writeOut(msgCache.INSTRUCTIONS, numDiv, 'h3', true);
                        writeOut(`${MIN} - ${MAX}`, numDiv,'h3', false);

                        if(answer.code === 2040) {
                            writeOut(answer.msg, outDiv, 'h2', true);
                        }

                    })
                }
            });
        }
        else {
            sendError(MSG_KEY.NO_NAME);
        }
    }

    function checkUser(input) {
        let output = input;
        if(input) {
            let whitespace = /\s/.test(input);
            if(whitespace) {
                let words = input.split(/\s/);
                output = words.join('');
            }
            let slashes = /\//.test(output);
            if(slashes) {
                let words = output.split(/\//);
                output = words.join('');
            }
            let questions = /\?/.test(output);
            if(questions){
                let words = output.split(/\?/);
                output = words.join('');
            }
            let percent = /%/.test(output);
            if(percent) {
                let words = output.split(/%/);
                output = words.join('');
            }

            if(!output) {
                console.log("Valid usernames are filtered for whitespace, forward slashes, questions marks and percent signs.");
                return null;
            }

            return output;
        }
        else {
            return null;
        }
    }

    function checkGuess(input) {
        return input ? input : false;
    }





    function clearDiv(element) {
        element.innerHTML = "";
    }

    function writeOut(message, target, size, clear) {
        if(clear) {
            clearDiv(target);
        }

        let elm = document.createElement(size);
        elm.innerHTML = message;
        target.appendChild(elm);
    }

    function hitEnter(evt) {
        if(evt.keyCode === 13) {
            tryGuess();
        }
    }

    async function changeLang() {
        let lang = languageSelect.value;

        await fetch(`js/${lang}.json`).then (resp => {
                return resp.json();
            }
        ).then(resp => {

            msgCache = resp;

        }).catch(error => {
            console.error(`This language does not exist: ${error}`);
            }
        );

        usertxt.innerHTML = msgCache.USERNAME;
        guesstxt.innerHTML = msgCache.YOUR_GUESS;
        playerstxt.innerHTML = msgCache.PLAYERS;
        startbtn.innerHTML = msgCache.START;
        guessbtn.innerHTML = msgCache.GUESS;
    }


    function sendError(code) {
        writeOut(msgCache[code], outDiv, 'h2', true);
    }

</script>
>>>>>>> 576a7c6006c06c103ba5748d48bac9548bc1443a

</html>